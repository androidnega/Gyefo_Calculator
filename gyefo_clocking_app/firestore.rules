rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Everyone must be authenticated
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    // USERS collection
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isManager();
      allow write: if isManager();
    }

    // ATTENDANCE records
    match /attendance/{workerId}/records/{recordId} {
      // Workers: Only see & write their own records
      allow read, write: if request.auth.uid == workerId;

      // Managers: Can read all
      allow read: if isManager();
    }
    
    // Define reusable manager check
    function isManager() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'manager';
    }
  }
}